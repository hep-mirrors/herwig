#! /usr/bin/env python

import os,sys,glob,errno,shutil,argparse,time
 







def replacetext(fileName, sourceText, replaceText):
    file = open(fileName, "r") 
    text = file.read() 
    file.close()
    file = open(fileName, "w")
    file.write(text.replace(sourceText, replaceText))
    file.close() 

def mkdir_p(path):
    try:
        os.makedirs(path)
    except OSError as exc: # Python >2.5
        if exc.errno == errno.EEXIST and os.path.isdir(path):
            pass
        else: raise   
      
def find(name, path):
    for root, dirs, files in os.walk(path):
        if name in files:
            return os.path.join(root, name)      
 
def fillprocs(model):
  fileproc=open("proc.dat","w")
  fileproc.write("import model "+model+"\n")
  borns="BornAmplitudes.dat"
  virts="VirtAmplitudes.dat"
  
  first=True
  processmap=""
  procnr=0
  virtlines=""
  bornlines=""
  file = open(borns, "r")
  for line in file:
      linetmp=line.rstrip()
      procnr+=1
      processmap+=linetmp+" "
      processmap+=str(procnr) +"\n"
      if first:
	bornlines+="generate "+linetmp+" @"+str(procnr)+"\n"
	first=False
      else:
	bornlines+="add process "+linetmp+" @"+str(procnr)+"\n"
  file.close()
  first=True
  file = open(virts, "r")
  for line in file:
      linetmp=line.rstrip()+" [ virt=QCD ]"
      procnr+=1
      processmap+=linetmp+" "
      processmap+=str(procnr) +"\n"
      if first:
	virtlines+="generate "+linetmp+" @"+str(procnr)+"\n"
	first=False
      else:
	virtlines+="add process "+linetmp+" @"+str(procnr)+"\n"
  file.close()

  fileproc.write(bornlines)
  if virtlines!="" and bornlines!="":
     fileproc.write("output matchbox MG5 --postpone_model\n") 
  fileproc.write(virtlines)
  fileproc.write("output matchbox MG5 -f\n")
  

  fileproc.close()
  fileprocessmap=open("processmap.dat","w")
  fileprocessmap.write(processmap)
  fileprocessmap.close()



  
parser = argparse.ArgumentParser()
parser.add_argument('--path', help='installpath')
parser.add_argument('--build', help='build', action="store_true")
parser.add_argument('--bpath', help='buildpath')
parser.add_argument('--model', help='model')

args = parser.parse_args()


param_card=""
if args.model=="loop_sm" or args.model=="heft":

  if args.model=="loop_sm":
    param_card="param_card.dat"
  else:
    param_card="param_card_"+args.model+".dat"  
    
  file = open("@prefix@/share/Herwig++/MadGraphInterface/"+param_card+".in", "r") 
  paramcard = file.read() 
  file.close()
  file = open(param_card, "w")

  params=open(args.path+"/MG-Parameter.dat", "r")

  for line in params:
    a=line.split()
    paramcard=paramcard.replace(a[0],a[1])
  params.close()
  file.write(paramcard)
  file.close()   
else:
  print "---------------------------------------------------------------"
  print "---------------------------------------------------------------"
  print "Warning: The model set for the MadGraph Interface "
  print "         needs a parameter ssetting by hand."
  print "         Please fill the param_card.dat"
  print "         this you favourite assumptions."
  print "         And make sure Herwig uses the same parameters."
  print "---------------------------------------------------------------"
  print "---------------------------------------------------------------"
  
  time.sleep(5)
  if not os.path.isfile("param_card.dat"):
    os.system("cp "+find("param_card.dat",args.path)+" "+pwd )


pwd=os.getcwd() 
if "SubProcesses" in os.listdir(pwd):
  os.unlink(pwd+"/SubProcesses")
if "Cards" in os.listdir(pwd):
  os.unlink(pwd+"/Cards")
  

  
if  not args.build:
  os.system("ln -s "+args.path+"/MG5/SubProcesses "+pwd )
  os.system("ln -s "+args.path+"/MG5/Cards "+pwd )
  os.system("cp "+find("ident_card.dat",args.path)+" "+pwd )
  containsall=True
  for filei in [args.path+"/VirtAmplitudes.dat",args.path+"/BornAmplitudes.dat"]:
    file = open(filei, "r")
    for line in file:
	contains=False
	fileprocessmap=open(args.path+"/processmap.dat","r")
	for line1 in fileprocessmap:
	  if line.rstrip() == line1.\
	    replace("add process","").\
	    replace("generate","").\
	    replace("[ virt=QCD ]","").rstrip().rstrip('0123456789').rstrip().lstrip():
	    contains=True
	containsall=(containsall and contains)
    file.close()
  if not containsall:
      print "---------------------------------------------------------------"
      print "---------------------------------------------------------------"
      print "Warning: The MadGraph-Amplitudes are not valid for the process."
      print "         Please remove the install folder."
      print "---------------------------------------------------------------"
      print "---------------------------------------------------------------"
      
      time.sleep(5)
  
  exit()




if not os.path.isdir(args.path):
   print "The MadGraph Install path was not existend. It has been created for you."
   print "Just start Herwig++ read again.."
   mkdir_p(args.path)
   exit()

os.chdir(args.path)
if os.path.isfile("InterfaceMadGraph.so"):
  containsall=True
  for filei in ["VirtAmplitudes.dat","BornAmplitudes.dat"]:
    file = open(filei, "r")
    for line in file:
	contains=False
	fileprocessmap=open("processmap.dat","r")
	for line1 in fileprocessmap:
	  if line in line1:

	    contains=True
	containsall=(containsall and contains)
    file.close()
  if containsall:
      exit()    
  
 
fillprocs(args.model)
os.system("python "+args.bpath+"/mg5_aMC proc.dat")
Bornlist=[]
Virtlist=[]
procs=open("proc.dat","r")
for line in procs:
  if "@" in line:
    if "[ virt=QCD ]" in line:
      Virtlist+=[line.split("@")[1].replace("\n","")]
    else:
      Bornlist+=[line.split("@")[1].replace("\n","")]
routines=[["","BORN(momenta,hel)"],
	 ["","SLOOPMATRIX(momenta,virt)"],
	 ["","GET_JAMP(color,Jamp)"],
	 ["","GET_LNJAMP(color,Jamp)"],
	 ["","GET_NCOL(color)"],
	 ["","GET_NCOLOR(i,j,color)"]]
for routine in routines:
  for i in Bornlist + list(set(Virtlist) - set(Bornlist)):
    if routine[1]=="Virt(amp)" or routine[1]=="SLOOPMATRIX(momenta,virt)" and i not in  Virtlist:
      continue
    if routine[0]=="":
       routine[0]+="         IF (proc .EQ. "+i+") THEN\n            CALL "
       routine[0]+=   "P"+i+"_"+routine[1]+"\n"
    else:
       routine[0]+="         ELSE IF (proc .EQ. "+i+") THEN\n"\
               "            CALL "
       routine[0]+=   "P"+i+"_"+routine[1]+"\n"
  if routine[0]!="":	     
       routine[0]+="         ELSE\n"
       routine[0]+="             WRITE(*,*) '##W02A WARNING No id found '\n"
       routine[0]+="         ENDIF   \n"


procs.close()
procs=open("proc.dat","r")

#MG_Procnametxt=""
#for line in procs:
  #if "@" in line:
      #if MG_Procnametxt=="":
         #MG_Procnametxt+="         IF (proc .EQ. "+line.split("@")[1].replace("\n","")+") THEN\n            "
         #MG_Procnametxt+="name=\'"+line.split("@")[0]\
	                          #.replace("[ virt=QCD ]","")\
				  #.replace("generate","")\
				  #.replace("add process","")+"\'\n"
      #else:
	 #MG_Procnametxt+="         ELSE IF (proc .EQ. "+line.split("@")[1].replace("\n","")+") THEN\n             "
         #MG_Procnametxt+="name=\'"+line.split("@")[0]\
	                          #.replace("[ virt=QCD ]","")\
				  #.replace("generate","")\
				  #.replace("add process","")+"\'\n"
#if MG_Procnametxt!="":	     
	 #MG_Procnametxt+="         ELSE\n"
	 #MG_Procnametxt+="             WRITE(*,*) '##W02A WARNING No id found '\n"
	 #MG_Procnametxt+="         ENDIF   \n"




shutil.copyfile("@prefix@/share/Herwig++/MadGraphInterface/InterfaceMadGraph.f.in", "InterfaceMadGraph.f")
if param_card !="":
  replacetext("InterfaceMadGraph.f","MG_InitProctxt","         CALL setpara('"+param_card+"')")
else:
  replacetext("InterfaceMadGraph.f","MG_InitProctxt","         CALL setpara('param_card.dat')")
replacetext("InterfaceMadGraph.f","MG_CalculateBORNtxt",routines[0][0])
replacetext("InterfaceMadGraph.f","MG_CalculateVIRTtxt",routines[1][0])
replacetext("InterfaceMadGraph.f","MG_Jamptxt",     routines[2][0])
replacetext("InterfaceMadGraph.f","MG_LNJamptxt",     routines[3][0])
replacetext("InterfaceMadGraph.f","MG_NColtxt",     routines[4][0])
replacetext("InterfaceMadGraph.f","MG_ColourMattxt",routines[5][0])
#replacetext("InterfaceMadGraph.f","MG_Procnametxt",MG_Procnametxt)

MG_vxxxxxtxt=""
if routines[1][0]!="":
  MG_vxxxxxtxt="""       subroutine  MG_vxxxxx(p, n,inc,VC)
     $   bind(c, name='MG_vxxxxx')
         IMPLICIT NONE
         double precision p(0:3)
         double precision n(0:3)
         INTEGER inc
         double precision VC(0:7)
         double complex  VCtmp(0:4)
         double complex  Ninplus(8)
         double complex  Noutminus(8)
         double complex  Pinplus(8)
         double complex  Poutplus(8)
         double complex   denom
         double complex  IMAG1
         PARAMETER (IMAG1=(0D0,1D0))
         CALL IXXXXX(n, 0.0d0, +1, +1, Ninplus);  ! |n+>
         CALL OXXXXX(p, 0.0d0, +1, +1, Poutplus); ! <p+|
         CALL OXXXXX(n, 0.0d0, -1, +1, Noutminus);!  <n-|
         CALL IXXXXX(p, 0.0d0, +1, +1, Pinplus);  ! |p+>
         !<p+| gamma_mu |n+>
         VCtmp(0)=Ninplus(5)*Poutplus(7)+Ninplus(6)*Poutplus(8)+
     $             Ninplus(7)*Poutplus(5)+Ninplus(8)*Poutplus(6)
         VCtmp(1)=(Ninplus(7)*Poutplus(6)+Ninplus(8)*Poutplus(5)-
     $             Ninplus(5)*Poutplus(8)-Ninplus(6)*Poutplus(7))
         VCtmp(2)=(-IMAG1*(Ninplus(5)*Poutplus(8)+Ninplus(8) 
     $             * Poutplus(5))+IMAG1*(Ninplus(6)*Poutplus(7)
     $             + Ninplus(7)*Poutplus(6)));
         VCtmp(3)=(Ninplus(6)*Poutplus(8)+Ninplus(7)*Poutplus(5)-
     $              Ninplus(5)*Poutplus(7)-Ninplus(8)*Poutplus(6))
         denom= (Pinplus(5)*Noutminus(5)+Pinplus(6)
     $          *Noutminus(6)+Pinplus(7)*Noutminus(7)
     $          +Pinplus(8)*Noutminus(8))*sqrt(2.d0)
          if (inc.gt.1 )THEN
            denom=denom*-1.0d0
            if (abs(VCtmp(3)).ne.0.d0)THEN
             denom=denom* (VCtmp(3))/abs(VCtmp(3))
            endif
            if (abs(VCtmp(1)).ne.0.d0)THEN
              denom=denom* (VCtmp(1))/abs(VCtmp(1))
            endif
          endif
         VCtmp(0)=-1.0d0*VCtmp(0)/denom
         VCtmp(1)=-1.0d0*VCtmp(1)/denom
         VCtmp(2)=-1.0d0*VCtmp(2)/denom
         VCtmp(3)=-1.0d0*VCtmp(3)/denom
         VC(0)= real(VCtmp(0))
         VC(1)=aimag(VCtmp(0))  
         VC(2)= real(VCtmp(1))
         VC(3)=aimag(VCtmp(1))  
         VC(4)= real(VCtmp(2))
         VC(5)=aimag(VCtmp(2))  
         VC(6)= real(VCtmp(3))
         VC(7)=aimag(VCtmp(3))  
       END"""
else:
  MG_vxxxxxtxt="""       subroutine  MG_vxxxxx(p, n,inc,VC)
     $   bind(c, name='MG_vxxxxx')
         IMPLICIT NONE
         double precision p(0:3)
         double precision n(0:3)
         INTEGER inc
         double precision VC(0:7)
         double complex  VCtmp(0:4)
         double complex  Ninplus(6)
         double complex  Noutminus(6)
         double complex  Pinplus(6)
         double complex  Poutplus(6)
         double complex   denom
         double complex  IMAG1
         PARAMETER (IMAG1=(0D0,1D0))
         CALL IXXXXX(n, 0.0d0, +1, +1, Ninplus);  ! |n+>
         CALL OXXXXX(p, 0.0d0, +1, +1, Poutplus); ! <p+|
         CALL OXXXXX(n, 0.0d0, -1, +1, Noutminus);!  <n-|
         CALL IXXXXX(p, 0.0d0, +1, +1, Pinplus);  ! |p+>
         !<p+| gamma_mu |n+>
         VCtmp(0)=Ninplus(3)*Poutplus(5)+Ninplus(4)*Poutplus(6)+
     $             Ninplus(5)*Poutplus(3)+Ninplus(6)*Poutplus(4)
         VCtmp(1)=(Ninplus(5)*Poutplus(4)+Ninplus(6)*Poutplus(3)-
     $             Ninplus(3)*Poutplus(6)-Ninplus(4)*Poutplus(5))
         VCtmp(2)=(-IMAG1*(Ninplus(3)*Poutplus(6)+Ninplus(6) 
     $             * Poutplus(3))+IMAG1*(Ninplus(4)*Poutplus(5)
     $             + Ninplus(5)*Poutplus(4)));
         VCtmp(3)=(Ninplus(4)*Poutplus(6)+Ninplus(5)*Poutplus(3)-
     $              Ninplus(3)*Poutplus(5)-Ninplus(6)*Poutplus(4))
         denom= (Pinplus(3)*Noutminus(3)+Pinplus(4)
     $          *Noutminus(4)+Pinplus(5)*Noutminus(5)
     $          +Pinplus(6)*Noutminus(6))*sqrt(2.d0)
          if (inc.gt.1 )THEN
            denom=denom*-1.0d0
            if (abs(VCtmp(3)).ne.0.d0)THEN
             denom=denom* (VCtmp(3))/abs(VCtmp(3))
            endif
            if (abs(VCtmp(1)).ne.0.d0)THEN
              denom=denom* (VCtmp(1))/abs(VCtmp(1))
            endif
          endif
         VCtmp(0)=-1.0d0*VCtmp(0)/denom
         VCtmp(1)=-1.0d0*VCtmp(1)/denom
         VCtmp(2)=-1.0d0*VCtmp(2)/denom
         VCtmp(3)=-1.0d0*VCtmp(3)/denom
         VC(0)= real(VCtmp(0))
         VC(1)=aimag(VCtmp(0))  
         VC(2)= real(VCtmp(1))
         VC(3)=aimag(VCtmp(1))  
         VC(4)= real(VCtmp(2))
         VC(5)=aimag(VCtmp(2))  
         VC(6)= real(VCtmp(3))
         VC(7)=aimag(VCtmp(3))  
       END"""
replacetext("InterfaceMadGraph.f","MG_vxxxxxtxt",MG_vxxxxxtxt)


make=" "
files1=glob.glob('*/*/*.f')
files2=glob.glob('*/*/*/*.f')
for i in files1+files2:
  if "check_sa" not in i:
   make += " "+i

files1=glob.glob('*/*/*.inc')
files2=glob.glob('*/*/*/*.inc')
coefdir=""
for i in files1+files2:
  if "nexternal.inc" in i:
   coefdir+=" -I"+i.replace("nexternal.inc"," ")


file=open("makefile","w")
file.write("include MG5/Source/make_opts\n")
file.write("LIBDIR = MG5/lib\n")
if Virtlist!=[]:
    file.write("LINKLIBS =  -L$(LIBDIR) -lcts \n")
    file.write("LIBS =  $(LIBDIR)libcts.$(libext) \n")
file.write("PROCESS= InterfaceMadGraph.f "+make)
file.write("\n\nall:  \n\t gfortran  $(FFLAGS) -fPIC -fno-f2c -shared -s -o  InterfaceMadGraph.so -IMG5/SubProcesses/ ")
if coefdir != "":
   file.write(coefdir)
file.write("   $(PROCESS) $(LINKLIBS) ")
file.close()

os.system("make")

os.system("ln -s "+args.path +"/MG5/SubProcesses "+pwd )
os.system("ln -s "+args.path +"/MG5/Cards "+pwd )
os.system("cp "+find("ident_card.dat",args.path)+" "+pwd )
if param_card =="":
  os.system("cp "+find("param_card.dat",args.path)+" "+pwd )
if(find("MadLoopParams.dat",args.path)):
  os.system("cp "+find("MadLoopParams.dat",args.path)+" "+pwd )
os.chdir(pwd)