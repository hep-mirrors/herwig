#! @PYTHON@
# -*- mode: python -*-
from __future__ import print_function
import logging, sys, math, subprocess, time
from herwigyoda import mergeHistos

if sys.version_info[:3] < (2,4,0):
    print ("rivet scripts require Python version >= 2.4.0... exiting")
    sys.exit(1)

import os, yoda, copy
#############################################

def useOne(hpath, sqrts):
    global inhistos
    global outhistos
    try:
        outhistos[hpath] =  inhistos[hpath][float(sqrts)]
    except:
        pass

if __name__ == "__main__":
    import logging
    from optparse import OptionParser, OptionGroup
    parser = OptionParser(usage="%prog name")
    verbgroup = OptionGroup(parser, "Verbosity control")
    verbgroup.add_option("-v", "--verbose", action="store_const", const=logging.DEBUG, dest="LOGLEVEL",
                         default=logging.INFO, help="print debug (very verbose) messages")
    verbgroup.add_option("-q", "--quiet", action="store_const", const=logging.WARNING, dest="LOGLEVEL",
                         default=logging.INFO, help="be very quiet")
    parser.add_option_group(verbgroup)
    (opts, args) = parser.parse_args()
    logging.basicConfig(level=opts.LOGLEVEL, format="%(message)s")

    ## Check args
    if len(args) < 1:
        logging.error("Must specify at least the name of the files")
        sys.exit(1)

#######################################

name=args[0].replace("Fixed","")
yodafiles=["ISR%s-44-Z-mu.yoda"        %name,
           "ISR%s-62-Z-mu.yoda"        %name,
           "ISR%s-44-UE.yoda"          %name,
           "ISR%s-62-UE.yoda"          %name,
           "SppS%s-63-UE.yoda"         %name,
           "ISR%s-30-UE.yoda"          %name, 
           "ISR%s-53-UE.yoda"          %name,
           "SppS%s-200-UE.yoda"        %name,
           "SppS%s-500-UE.yoda"        %name,
           "SppS%s-900-UE.yoda"        %name,
           "SppS%s-546-UE.yoda"        %name,
           "SppS%s-53-UE.yoda"         %name,
           "EHS%s-UE.yoda"             %name,
           "EHS-Pion%s-UE.yoda"        %name,
           "SPS%s-17.4-UE.yoda"        %name,
           "SPS%s-200-Z-mu.yoda"       %name,
           "Fermilab%s-27.4-Z-mu.yoda" %name,
           "Fermilab%s-38.8-Z-mu.yoda" %name]

## Get histos
inhistos = {}
outhistos={}
for fname in yodafiles:
    file = 'Rivet-'+fname
    if(file.find("44")>0) :
        sqrts=44
    elif(file.find("63")>0) :
        sqrts=63
    elif(file.find("30")>0) :
        sqrts=30
    elif(file.find("53")>0) :
        sqrts=53
    elif(file.find("200")>0) :
        sqrts=200
    elif(file.find("500")>0) :
        sqrts=500
    elif(file.find("900")>0) :
        sqrts=900
    elif(file.find("546")>0) :
        sqrts=546
    elif(file.find("53")>0) :
        sqrts=53
    elif(file.find("EHS")>0) :
        sqrts=math.sqrt(2.*.938*250.)
    if not os.access(file, os.R_OK):
        logging.error("%s can not be read" % file)
        continue
    try:
        aos = yoda.read(file)
    except:
        logging.error("%s can not be parsed as yoda" % file)
        continue
    ## Get histos from this YODA file
    for aopath, ao in aos.items() :
        if("RAW" in aopath) :continue
        if "-x" not in aopath : continue
        if(aopath.find("1926373")>0 or aopath.find("1867512")>0 or
           aopath.find("1583476")>0 or aopath.find("2044935")>0 or
           aopath.find("1178091")>0 ) :
            if aopath not in inhistos:
                inhistos[aopath] = {}
            if sqrts not in inhistos:
                inhistos[aopath][sqrts] = ao
            else:
                raise Exception("A set with sqrts = %s already exists" % ( sqrts))
        else :
            outhistos[aopath] = ao

# UA5_1989_I267179
useOne("/UA5_1989_I267179/d01-x01-y01","200")
useOne("/UA5_1989_I267179/d02-x01-y01","900")
useOne("/UA5_1989_I267179/d03-x01-y01","200")
useOne("/UA5_1989_I267179/d04-x01-y01","200")
useOne("/UA5_1989_I267179/d05-x01-y01","200")
useOne("/UA5_1989_I267179/d06-x01-y01","200")
useOne("/UA5_1989_I267179/d07-x01-y01","900")
useOne("/UA5_1989_I267179/d08-x01-y01","900")
useOne("/UA5_1989_I267179/d09-x01-y01","900")
useOne("/UA5_1989_I267179/d10-x01-y01","900")
useOne("/UA5_1989_I267179/d11-x01-y01","200")
useOne("/UA5_1989_I267179/d12-x01-y01","900")
# UA5_1988_I263399
useOne("/UA5_1988_I263399/d02-x01-y01","200")
useOne("/UA5_1988_I263399/d02-x01-y02","546")
useOne("/UA5_1988_I263399/d02-x01-y03","900")
useOne("/UA5_1988_I263399/d03-x01-y01","200")
useOne("/UA5_1988_I263399/d03-x01-y02","546")
useOne("/UA5_1988_I263399/d03-x01-y03","900")
# UA5_1986_I233599
useOne("/UA5_1986_I233599/d01-x01-y01","200")
useOne("/UA5_1986_I233599/d01-x01-y02","200")
useOne("/UA5_1986_I233599/d01-x01-y03","900")
useOne("/UA5_1986_I233599/d01-x01-y04","900")
useOne("/UA5_1986_I233599/d02-x01-y01","200")
useOne("/UA5_1986_I233599/d02-x01-y02","200")
useOne("/UA5_1986_I233599/d02-x01-y03","200")
useOne("/UA5_1986_I233599/d02-x01-y04","200")
useOne("/UA5_1986_I233599/d02-x01-y05","200")
useOne("/UA5_1986_I233599/d02-x01-y06","200")
useOne("/UA5_1986_I233599/d03-x01-y01","900")
useOne("/UA5_1986_I233599/d03-x01-y02","900")
useOne("/UA5_1986_I233599/d03-x01-y03","900")
useOne("/UA5_1986_I233599/d03-x01-y04","900")
useOne("/UA5_1986_I233599/d03-x01-y05","900")
useOne("/UA5_1986_I233599/d03-x01-y06","900")
useOne("/UA5_1986_I233599/d03-x01-y07","900")
useOne("/UA5_1986_I233599/d03-x01-y08","900")
useOne("/UA5_1986_I233599/d03-x01-y09","900")
# UA1_1990_I280412
useOne("/UA1_1990_I280412/d01-x01-y01","200")
useOne("/UA1_1990_I280412/d01-x01-y02","500")
useOne("/UA1_1990_I280412/d01-x01-y03","900")
useOne("/UA1_1990_I280412/d02-x01-y01","200")
useOne("/UA1_1990_I280412/d02-x01-y02","500")
useOne("/UA1_1990_I280412/d02-x01-y03","900")
useOne("/UA1_1990_I280412/d03-x01-y01","900")
useOne("/UA1_1990_I280412/d04-x01-y01","900")
useOne("/UA1_1990_I280412/d05-x01-y01","900")
useOne("/UA1_1990_I280412/d06-x01-y01","200")
useOne("/UA1_1990_I280412/d07-x01-y01","900")
useOne("/UA1_1990_I280412/d08-x01-y01","63")
useOne("/UA1_1990_I280412/d09-x01-y01","200")
useOne("/UA1_1990_I280412/d10-x01-y01","500")
useOne("/UA1_1990_I280412/d11-x01-y01","900")
useOne("/UA1_1990_I280412/d12-x01-y01","200")
useOne("/UA1_1990_I280412/d12-x01-y02","500")
useOne("/UA1_1990_I280412/d12-x01-y03","900")
# SFM_1984_I196601
useOne("/SFM_1984_I196601/d01-x01-y01","30")
useOne("/SFM_1984_I196601/d01-x01-y02","44")
useOne("/SFM_1984_I196601/d01-x01-y03","53")
useOne("/SFM_1984_I196601/d01-x01-y04","63")
useOne("/SFM_1984_I196601/d02-x01-y01","30")
useOne("/SFM_1984_I196601/d02-x01-y02","44")
useOne("/SFM_1984_I196601/d02-x01-y03","53")
useOne("/SFM_1984_I196601/d02-x01-y04","63")

# Star with different pT slices
mergeargs=["rivet-merge","--assume-reentrant"]
for i in range(1,5) :
    fname = "Rivet-Star-Jets-%s.yoda" % i
    if(os.path.isfile(fname)) : mergeargs.append(fname)
if len(mergeargs)!=2 :
    mergeargs.append("-o")
    mergeargs.append("Rivet-Star-Jets.yoda")
    p = subprocess.Popen(mergeargs)
    # need a sleep here otherwise merged files not ready
    time.sleep(5)

histos_UE={}
histos_Jets={}
yodafiles=["-UE.yoda","-Jets.yoda"]
for f in yodafiles : 
    fname='Rivet-Star'+f
    if not os.access(fname, os.R_OK):
        logging.error("%s can not be read" % fname)
        continue
    try:
        aos = yoda.read(fname)
    except:
        logging.error("%s can not be parsed as YODA" % fname)
        continue
    ## Get histos from this YODA fname
    for path, ao in aos.items() :
        if ("RAW" in path or "_XSEC" in path or "_EVTCOUNT" in path or "_BEAMPZ" in path or
            "sumWTrig" in path or "totalNum" in path or "sumWeights" in path) : continue
        if "HELEN" in path : 
            if "UE" in fname     : histos_UE[path]  =ao
            elif "Jets" in fname : histos_Jets[path]=ao
        else :
            outhistos[path]=ao
if len(histos_UE) !=0 :
    for key in histos_UE.keys() :
        outhistos[key]=mergeHistos(histos_UE[key],histos_Jets[key])

# Choose output file
name = args[0]+".yoda"
# output the yoda file
yoda.writeYODA(outhistos,name)
sys.exit(0)
