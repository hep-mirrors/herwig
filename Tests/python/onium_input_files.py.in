#! @PYTHON@
#-*- mode: python -*-
from __future__ import print_function
import logging,sys,os
from string import Template
from HerwigInputs import *
import sys
if sys.version_info[:3] < (2,4,0):
    print ("rivet scripts require Python version >= 2.4.0... exiting")
    sys.exit(1)

if __name__ == "__main__":
    import logging
    from optparse import OptionParser, OptionGroup
    parser = OptionParser(usage="%prog name [...]")
    
(opts, args) = parser.parse_args()
## Check args
if len(args) != 1:
    logging.error("Must specify at least input file")
    sys.exit(1)
    
name = args[0]
print (name)
# work out name and type of the collider
(collider,have_hadronic_collider) = identifyCollider(name)

thefactory="Factory"
octetEnhance={ "Jpsi" : 1e2, "psi(2S)" : 1e2, "chi_c0" : 1e2, "chi_c1" : 1e2, "chi_c2" : 1e2,
               "Upsilon" : 1e4, "Upsilon(2S)" : 1e4, "Upsilon(3S)" : 1e4,
               "chi_b0" : 1e2, "chi_b1" : 1e2, "chi_b2" : 1e2,
               "chi_b0(2P)" : 1e2, "chi_b1(2P)" : 1e2, "chi_b2(2P)" : 1e2,
               "chi_b0(3P)" : 1e2, "chi_b1(3P)" : 1e2, "chi_b2(3P)" : 1e2,
               "B_c+" : 1e2, "B_c*+" : 1e2, "B_c(2S)+" : 1e2, "B_c(2S)*+" : 1e2 }
singletEnhance = { "Jpsi" : 1e3, "eta_c" : 1e3 , "psi(2S)" : 1e3,  "chi_c0" : 1e3, "chi_c1" : 1e3, "chi_c2" : 1e3,
                   "Upsilon" : 1e4,"Upsilon(2S)" : 1e4,"Upsilon(3S)" : 1e4,
                   "chi_b0" : 1e4, "chi_b1" : 1e4, "chi_b2" : 1e4,
                   "chi_b0(2P)" : 1e4, "chi_b1(2P)" : 1e5, "chi_b2(2P)" : 1e5,
                   "chi_b0(3P)" : 1e6, "chi_b1(3P)" : 1e6, "chi_b2(3P)" : 1e6,
                   "B_c+" : 1e2, "B_c*+" : 1e2, "B_c(2S)+" : 1e2, "B_c(2S)*+" : 1e2 }
gluonSingletEnhance= { "Jpsi" : 1e4, "psi(2S)" : 1e4,  "chi_c0" : 1e4, "chi_c1" : 1e4, "chi_c2" : 1e4,
                       "Upsilon" : 1e5, "Upsilon(2S)" : 1e5, "Upsilon(3S)" : 1e5,
                       "chi_b0" : 1e4, "chi_b1" : 1e4, "chi_b2" : 1e4,
                       "chi_b0(2P)" : 1e4, "chi_b1(2P)" : 1e4, "chi_b2(2P)" : 1e4,
                       "chi_b0(3P)" : 1e4, "chi_b1(3P)" : 1e4, "chi_b2(3P)" : 1e4,
                       "B_c+" : 1e4, "B_c*+" : 1e4, "B_c(2S)+" : 1e4, "B_c(2S)*+" : 1e4   }
# settings for four flavour scheme
fourFlavour="""
read Matchbox/FourFlavourScheme.in
{bjetgroup}
set /Herwig/Cuts/MatchboxJetMatcher:Group bjet
""".format(bjetgroup=particlegroup(thefactory,'bjet','b','bbar','c', 'cbar',
                                   's','sbar','d','dbar','u','ubar','g'))

# workout the type of simulation
(simulation,templateName,parameterName,parameters)=identifySimulation(name,collider,have_hadronic_collider)


# DIS
if(collider=="DIS") :
    logging.error ("DIS processes not currently supported for onium production")
    sys.exit(1)
# EE
elif(collider=="EE") :
    logging.error ("EE processes not currently supported for onium production")
    sys.exit(1)
# EE-Gamma
elif(collider=="EE-Gamma") :
    logging.error ("EE-Gamma processes not currently supported for onium production")
    sys.exit(1)
elif(collider=="GammaGamma") :
    logging.error ("GammaGamma processes not currently supported for onium production")
    sys.exit(1)
# TVT
elif(collider=="TVT") :
    logging.error ("Tevatron processes not currently supported for onium production")
    sys.exit(1)
# Star
elif(collider=="Star" ) :
    logging.error ("Star processes not currently supported for onium production")
    sys.exit(1)
# ISR and SppS
elif ( collider=="ISR" or collider =="SppS" or collider == "SPS" or collider == "Fermilab" ) :
    logging.error ("ISR/SppS/SPS/Fixed target processes not currently supported for onium production")
    sys.exit(1)      
# LHC
elif(collider=="LHC") :
    ecms=7000.0
    if   parameterName.startswith("LHC-7-")   : ecms = 7000.0
    elif parameterName.startswith("LHC-8-")   : ecms = 8000.0
    elif parameterName.startswith("LHC-13-")  : ecms = 13000.0
    elif parameterName.startswith("LHC-900")  : ecms = 900.0
    elif parameterName.startswith("LHC-2360") : ecms = 2360.0
    elif parameterName.startswith("LHC-2760") : ecms = 2760.0
    elif parameterName.startswith("LHC-5-")   : ecms = 5020.0
    else                                  : ecms = 7000.0
    process = StringBuilder(collider_lumi(ecms))
    if(simulation=="") :
        cuts=[5,10,20,40,80,ecms]
        if "Charm" in parameterName :
            process+="cp MEHeavyQuark MECharm\n" 
            process+="set MECharm:QuarkType Charm\n"
            process+=insert_ME("MECharm")
            cuts[0]=0.
        elif "Bottom" in parameterName :
            process+="cp MEHeavyQuark MEBottom\n" 
            process+="set MEBottom:QuarkType Bottom\n"
            process+=insert_ME("MEBottom")
            cuts[0]=0.
        elif "Jets" in parameterName :
            process+=insert_ME("MEQCD2to2")
            process+="set MEQCD2to2:MaximumFlavour 3\n"
        else :
            logging.error(" Process %s not supported for internal matrix elements" % name)
            sys.exit(1)
        process+="set /Herwig/UnderlyingEvent/MPIHandler:IdenticalToUE 0\n"
        icut = int(parameterName.split("-")[-1])
        process+=jet_kt_cut(cuts[icut-1],cuts[icut])
    elif simulation=="Powheg" :
        logging.error(" Process %s not supported for internal POWHEG matrix elements" % name)
        sys.exit(1)
    elif( simulation=="Matchbox" or simulation=="Merging" ) :
        cuts=[5,10,20,40,80,ecms]
        if "Charm" in parameterName :
            parameters["bscheme"]=fourFlavour
            process+="set /Herwig/Particles/c:HardProcessMass 1.2*GeV\n"
            process+="set /Herwig/Particles/cbar:HardProcessMass 1.2*GeV\n"
            if(simulation=="Matchbox"):
                process+=addProcess(thefactory,"p p c cbar","2","0","MaxJetPtScale",0,0)
            elif(simulation=="Merging"):
                process+=addProcess(thefactory,"p p c cbar","2","0","MaxJetPtScale",1,0)
            cuts[0]=0.
        elif "Bottom" in parameterName :
            parameters["bscheme"]=fourFlavour
            process+="set /Herwig/Particles/b:HardProcessMass 4.2*GeV\n"
            process+="set /Herwig/Particles/bbar:HardProcessMass 4.2*GeV\n"
            if(simulation=="Matchbox"):
                process+=addProcess(thefactory,"p p b bbar","2","0","MaxJetPtScale",0,0)
            elif(simulation=="Merging"):
                process+=addProcess(thefactory,"p p b bbar","2","0","MaxJetPtScale",1,0)
            cuts[0]=0.
        elif "Jets" in parameterName :
            parameters["bscheme"]=particlegroup(thefactory,'lightjet',
                                                's','sbar','d','dbar','u','ubar','g')
            if(simulation=="Matchbox"):
                process+=addProcess(thefactory,"p p lightjet lightjet","2","0","MaxJetPtScale",0,0)
            elif(simulation=="Merging"):
                process+=addProcess(thefactory,"p p lightjet lightjet","2","0","MaxJetPtScale",1,1)
        else :
            logging.error(" Process %s not supported for Matchbox matrix elements" % name)
            sys.exit(1)
        icut = int(parameterName.split("-")[-1])
        process+=addFirstJet(cuts[icut-1],cuts[icut])
# LHC-GammaGamma
elif(collider=="LHC-GammaGamma" ) :
    logging.error ("LHC-GammaGamma processes not currently supported for onium production")
    sys.exit(1)
temp = parameterName.split("-")
parameterName=temp[1]
colour=temp[2]
particle=temp[3].replace("2S","(2S)").replace("3S","(3S)").replace("2P","(2P)").replace("3P","(3P)").replace("Star","*")
if "B_c" in particle :
    particle+="+"
pFile = os.path.join(collider,"{c}-{pn}-Quarkonium.in".format(c=collider, pn=parameterName))
with open(os.path.join("Rivet",pFile), 'r') as f:
    parameters['parameterFile'] = f.read()
# non-prompt
if colour == "NonPrompt" :
    if particle=="Charm" or particle == "Bottom":
        pFile = os.path.join(collider,"{c}-{pn}-Charm.in".format(c=collider, pn=parameterName))
        with open(os.path.join("Rivet",pFile), 'r') as f:
            parameters['parameterFile'] += f.read()
    if particle=="Bottom":
        pFile = os.path.join(collider,"{c}-{pn}-Bottom.in".format(c=collider, pn=parameterName))
        with open(os.path.join("Rivet",pFile), 'r') as f:
            parameters['parameterFile'] += f.read()
# now the onium shower stuff
else:
    parameters["shower"] += "read snippets/OniumShower.in\n"
    sfile=open("../src/snippets/OniumShower.in")
    line=sfile.readline()
    while line :
        if "AddFinalSplitting" in line :
            sudakov=line.split()[-1]
            nprod = len(line.split("->")[1].split(";")[0].split(","))
            if colour == "Singlet" and nprod == 2 :
                enhance = singletEnhance[particle]
                if "g->" in line and particle in ["Jpsi","psi(2S)","Upsilon","Upsilon(2S)","Upsilon(3S)"]:
                    enhance = gluonSingletEnhance[particle]
                if particle == "All" :
                    parameters["shower"] += "set /Herwig/Shower/%s:EnhancementFactor %s\n" % (sudakov,enhance)
                else :
                    if particle+";" in line or (particle[-1]=="+" and  particle.replace("+","-")+";" in line):
                        parameters["shower"] += "set /Herwig/Shower/%s:EnhancementFactor %s\n" % (sudakov,enhance)
                    else :
                        parameters["shower"] += line.replace("AddFinal","DeleteFinal").replace("SplittingGenerator","/Herwig/Shower/SplittingGenerator").replace(sudakov,"/Herwig/Shower/"+sudakov)
            elif colour == "Octet" and nprod == 1 :
                if particle == "All" :
                    parameters["shower"] += "set /Herwig/Shower/%s:EnhancementFactor %s\n" % (sudakov,octetEnhance[particle])
                else :
                    if particle+";" in line or (particle[-1]=="+" and  particle.replace("+","-")+";" in line):
                        parameters["shower"] += "set /Herwig/Shower/%s:EnhancementFactor %s\n" % (sudakov,octetEnhance[particle])
                    else :
                        parameters["shower"] += line.replace("AddFinal","DeleteFinal").replace("SplittingGenerator","/Herwig/Shower/SplittingGenerator").replace(sudakov,"/Herwig/Shower/"+sudakov)
            else :
                parameters["shower"] += line.replace("AddFinal","DeleteFinal").replace("SplittingGenerator","/Herwig/Shower/SplittingGenerator").replace(sudakov,"/Herwig/Shower/"+sudakov)
        line=sfile.readline()

    # switch off hadronization and MPI
    process += "set /Herwig/Shower/ShowerHandler:MPIHandler NULL\n"
    process += "set /Herwig/Generators/EventGenerator:EventHandler:HadronizationHandler NULL\n"
    process += "set /Herwig/Analysis/Basics:CheckQuark No\n"

parameters['runname'] = 'Rivet-%s' % name
parameters['process'] = str(process)
if have_hadronic_collider :
    parameters['collider'] = "PPCollider.in"

# get template and write the file
with open(os.path.join("Rivet/Templates",templateName), 'r') as f:
    templateText = f.read()

template = Template( templateText )

with open(os.path.join("Rivet",name+".in"), 'w') as f:
        f.write( template.substitute(parameters) )
