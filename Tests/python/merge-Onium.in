#! @PYTHON@
#-*- mode: python -*-
from __future__ import print_function
import logging, sys,subprocess,math,time

if sys.version_info[:3] < (2,4,0):
    print ("rivet scripts require Python version >= 2.4.0... exiting")
    sys.exit(1)

import os, yoda

# #############################################
if __name__ == "__main__":
    import logging
    from optparse import OptionParser, OptionGroup
    parser = OptionParser(usage="%prog name")
    verbgroup = OptionGroup(parser, "Verbosity control")
    verbgroup.add_option("-v", "--verbose", action="store_const", const=logging.DEBUG, dest="LOGLEVEL",
                         default=logging.INFO, help="print debug (very verbose) messages")
    verbgroup.add_option("-q", "--quiet", action="store_const", const=logging.WARNING, dest="LOGLEVEL",
                         default=logging.INFO, help="be very quiet")
    parser.add_option_group(verbgroup)
    (opts, args) = parser.parse_args()
    logging.basicConfig(level=opts.LOGLEVEL, format="%(message)s")

    ## Check args
    if len(args) < 1:
        logging.error("Must specify at least the name of the files")
        sys.exit(1)

# #######################################
energies = { 5020 : ["ALICE_2017_I1511865"],
             7000 : ["ATLAS_2016_I1409298","LHCB_2015_I1316329", 
                     "LHCB_2015_I1392456","LHCB_2014_I1308738",
                     "LHCB_2017_I1621596"],
             8000 : ["ATLAS_2016_I1409298","LHCB_2015_I1316329",
                     "LHCB_2015_I1392456","LHCB_2014_I1308738",
                     "LHCB_2017_I1621596"],
             13000 : ["ALICE_2017_I1511865"] }
yodafiles=[]
processes=[]
for colour in ["Singlet","Octet"]: 
    for state in ["eta_c","Jpsi","psi2S","chi_c0","chi_c1","chi_c2",
                  "Upsilon","Upsilon2S","Upsilon3S","chi_b0","chi_b1","chi_b2",
                  "chi_b0(2P)","chi_b1(2P)","chi_b2(2P)","chi_b0(3P)","chi_b1(3P)","chi_b2(3P)"]:
        processes.append("%s-%s"%(colour,state))
processes.append("NonPrompt")

for energy in [2760,5,7,8,13]:
    if energy==2760 :
        ecms=energy
    elif energy==5 :
        ecms=5020
    else :
        ecms = energy*1000
    mergeargs2=["rivet-merge"]
    for state in processes:
        for proc in ["Charm","Bottom","Jets"] :
            mergeargs=["rivet-merge"]
            for cut in range(1,6):
                fname = "Rivet-Onium-%s-%s-%s-%s-%s.yoda" % (args[0], energy , state, proc, cut)
                if(os.path.isfile(fname)) :
                    mergeargs.append(fname)
                    mergeargs2.append(fname)
            if len(mergeargs)==1 : continue
            if ecms in energies:
                for val in energies[ecms]:
                    mergeargs.append("-a")
                    mergeargs.append("%s:ENERGY=%s" % (val,ecms))
            fname = "Rivet-Onium-%s-%s-%s-%s.yoda"% (args[0], energy , state, proc) 
            mergeargs.append("-o")
            mergeargs.append(fname)
            p = subprocess.Popen(mergeargs)
    if len(mergeargs2)==1 : continue
    if ecms in energies:
        for val in energies[ecms]:
            mergeargs2.append("-a")
            mergeargs2.append("%s:ENERGY=%s" % (val,ecms))
    fname = "Rivet-Onium-%s-%s.yoda"% (args[0], energy) 
    mergeargs2.append("-o")
    mergeargs2.append(fname)
    yodafiles.append(fname)
    p = subprocess.Popen(mergeargs2)
# need a sleep here otherwise merged files not ready
time.sleep(60) 
## Get histos
outhistos={}
for f in yodafiles:
    if not os.access(f, os.R_OK):
        logging.error("%s can not be read" % f)
        continue
    try:
        aos = yoda.read(f)
    except:
        logging.error("%s can not be parsed as YODA" % f)
        continue
    ## Get histos from this YODA file
    for aopath, ao in aos.items() :
        if("RAW" in aopath) : continue
        elif(aopath.find("_XSEC")>=0 or aopath.find("_EVTCOUNT")>=0) :
            continue
        elif "ALICE_2017_I1511865" in aopath :
            path=aopath.split(":")
            ao.setPath(path[0]+"/"+path[1].split("/")[1])
            if "d07" in aopath or "d08" in aopath :
                if "-5" in f : outhistos[ao.path()] = ao
            else :
                if "-5" not in f : outhistos[ao.path()] = ao
        elif "ATLAS_2016_I1409298" in aopath :
            path=aopath.split(":")
            ao.setPath(path[0]+"/"+path[1].split("/")[1])
            if ("d01" in aopath or "d03" in aopath or "d05" in aopath or
                "d07" in aopath or "d09" in aopath or "d11" in aopath or
                "d13" in aopath or "d15" in aopath) :
                if "-7" in f : outhistos[ao.path()] = ao
            else :
                if "-8" in f : outhistos[ao.path()] = ao
        elif "LHCB_2015_I1316329" in aopath :
            path=aopath.split(":")
            ao.setPath(path[0]+"/"+path[1].split("/")[1])
            if "d01" in aopath or "d03" in aopath :
                if "-7" in f : outhistos[ao.path()] = ao
            else :
                if "-8" in f : outhistos[ao.path()] = ao
        elif "LHCB_2014_I1308738" in aopath :
            path=aopath.split(":")
            ao.setPath(path[0]+"/"+path[1].split("/")[1])
            if "d01" in aopath or "d02" in aopath or "d03" in aopath :
                if "-7" in f : outhistos[ao.path()] = ao
            else :
                if "-8" in f : outhistos[ao.path()] = ao
        elif "LHCB_2017_I1621596" in aopath :
            path=aopath.split(":")
            ao.setPath(path[0]+"/"+path[1].split("/")[1])
            outhistos[aopath] = ao
        else :
            outhistos[aopath] = ao
            
# Choose output file
name = args[0]+"-Onium.yoda"
# remove any scatters with nans, causes yoda to crash
remove = [] 
for key in outhistos.keys() :
    ao = outhistos[key]
    if type(ao)==yoda.core.Scatter2D :
        skip=False
        for p in ao.points() :
            if math.isnan(p.y()) : skip=True
        if(skip) : remove.append(key)
for key in remove :
    if key in outhistos : del outhistos[key]
# output the yoda file
yoda.writeYODA(outhistos,name)
sys.exit(0)
